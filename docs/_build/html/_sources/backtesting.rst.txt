backtesting module
==================

.. automodule:: backtesting
   :members:
   :show-inheritance:
   :undoc-members:

Backtesting avancé
==================

.. automodule:: bitcoin_scalper.core.backtesting
   :members:
   :undoc-members:
   :show-inheritance:

Métriques post-trade calculées
-----------------------------

La classe ``Backtester`` calcule automatiquement les métriques suivantes après chaque backtest :

- **sharpe** : ratio de Sharpe annualisé (PnL/volatilité)
- **max_drawdown** : drawdown maximal observé
- **profit_factor** : somme des gains divisée par la somme des pertes
- **win_rate** : taux de trades gagnants
- **expectancy** : gain moyen par trade (espérance mathématique)
- **max_losing_streak** : plus longue série de trades perdants consécutifs
- **nb_trades** : nombre total de trades exécutés
- **final_return** : rendement total sur la période
- **final_capital** : capital final après backtest

Définitions :

- *Expectancy* : moyenne des PnL de tous les trades (positifs et négatifs). Permet d'estimer le gain moyen attendu par trade.
- *Profit factor* : rapport entre la somme des gains et la somme des pertes. Un profit factor >1 indique une stratégie globalement profitable.
- *Win rate* : proportion de trades gagnants sur l'ensemble des trades exécutés.
- *Max losing streak* : plus longue série de trades perdants consécutifs, indicateur du risque psychologique et de la robustesse de la stratégie.

Exemple de rapport JSON généré :

.. code-block:: json

    {
        "sharpe": 1.23,
        "max_drawdown": 0.12,
        "profit_factor": 1.8,
        "win_rate": 0.56,
        "expectancy": 12.5,
        "max_losing_streak": 4,
        "nb_trades": 50,
        "final_return": 0.32,
        "final_capital": 13200.0
    }

Logging et fallback automatique des features manquantes
------------------------------------------------------

En mode backtest ou trading live, toute erreur de features manquantes (fichier features_list.pkl absent, colonnes manquantes, etc.) est logguée explicitement. Un fallback automatique est appliqué : le bot bascule sur une stratégie alternative robuste si les features nécessaires à la prédiction ML sont absentes ou corrompues. Ce mécanisme garantit la continuité du service et la robustesse du bot face aux erreurs de données ou de pipeline ML.
