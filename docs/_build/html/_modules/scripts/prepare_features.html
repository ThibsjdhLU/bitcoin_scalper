<!DOCTYPE html>

<html lang="fr" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scripts.prepare_features &#8212; Documentation bitcoin_scalper 1.0</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=7a28dfa3"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=e6b791cb"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Code source de scripts.prepare_features</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinMaxScaler</span>

<span class="c1"># Ajouter le chemin du répertoire racine du projet pour pouvoir importer les modules locaux</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">)))</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bitcoin_scalper.core.feature_engineering</span><span class="w"> </span><span class="kn">import</span> <span class="n">FeatureEngineering</span>

<span class="c1"># --- Configuration ---</span>
<span class="n">INPUT_CSV_PATH</span> <span class="o">=</span> <span class="s2">&quot;data/features/BTCUSD_M1_201812120809_202505271849.csv&quot;</span> <span class="c1"># User provided path, ensure it&#39;s accessible or make it a placeholder if not.</span>
<span class="n">OUTPUT_CSV_PATH</span> <span class="o">=</span> <span class="s2">&quot;data/features/BTCUSD_M1_features_trend_following.csv&quot;</span> <span class="c1"># New output file name</span>

<div class="viewcode-block" id="check_temporal_integrity">
<a class="viewcode-back" href="../../core/preprocessing.html#scripts.prepare_features.check_temporal_integrity">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_temporal_integrity</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">indicator_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vérifie l&#39;absence de look-ahead bias : chaque indicateur doit être décalé d&#39;une bougie.</span>
<span class="sd">    Retourne True si aucune erreur, False sinon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">indicator_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indicator_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span>
            <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span>
        <span class="p">]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indicator_cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># On ignore la première ligne (toujours NaN après shift)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="n">shifted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERREUR] Look-ahead détecté sur la colonne </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[OK] Intégrité temporelle validée (aucun look-ahead bias détecté)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[ERREUR] </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> colonnes présentent un look-ahead bias !&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="generate_signal">
<a class="viewcode-back" href="../../core/preprocessing.html#scripts.prepare_features.generate_signal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_signal</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Génère la colonne &#39;signal&#39; (1=long, -1=short, 0=neutre) sur la base des indicateurs décalés.</span>
<span class="sd">    Stratégie très permissive : seulement EMA et RSI, seuils larges, pas de supertrend ni ATR.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">long_condition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ema_21&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ema_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">short_condition</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ema_21&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ema_50&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rsi_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">long_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">short_condition</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal_binary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Distribution des signaux (signal) :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="prepare_dataset">
<a class="viewcode-back" href="../../core/preprocessing.html#scripts.prepare_features.prepare_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_dataset</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pipeline complet :</span>
<span class="sd">    1. Chargement brut</span>
<span class="sd">    2. Ajout indicateurs (décalés)</span>
<span class="sd">    3. Calcul features dérivées (décalées)</span>
<span class="sd">    4. Génération du signal</span>
<span class="sd">    5. Gestion NaN ciblée</span>
<span class="sd">    6. Validation intégrité temporelle</span>
<span class="sd">    7. Export CSV sécurisé</span>
<span class="sd">    8. Normalisation + pondération des classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chargement des données brutes depuis </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur : Fichier non trouvé à </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur lors du chargement du fichier : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Préparation des données...&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;DATE&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;TIME&gt;&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;&lt;OPEN&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;TICKVOL&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;VOL&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;volume_zero&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;SPREAD&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;spread&#39;</span>
    <span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;volume_zero&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;volume_zero&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ajout des indicateurs techniques et features...&quot;</span><span class="p">)</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">price_col</span><span class="o">=</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="n">high_col</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="n">low_col</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">volume_col</span><span class="o">=</span><span class="s1">&#39;tickvol&#39;</span><span class="p">)</span>
    <span class="c1"># Calcul des features dérivées avec shift(1) après le rolling</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close_sma_3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr_sma_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;atr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Génération du signal robuste (stratégie assouplie)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">generate_signal</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="c1"># Gestion NaN ciblée (seulement sur les colonnes critiques)</span>
    <span class="n">indicator_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span>
        <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;signal_binary&#39;</span>
    <span class="p">]</span>
    <span class="n">initial_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suppression de </span><span class="si">{</span><span class="n">initial_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">initial_count</span><span class="si">}</span><span class="s2"> lignes (</span><span class="si">{</span><span class="p">(</span><span class="n">initial_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">initial_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>

    <span class="c1"># Validation intégrité temporelle</span>
    <span class="n">check_temporal_integrity</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">indicator_cols</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">)</span>

    <span class="c1"># Statistiques sur la cible</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distribution des signaux (signal) :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distribution binaire (signal_binary) :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">prop_long</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">prop_long</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[AVERTISSEMENT] Proportion de signaux LONG très faible (&lt;5%). Le modèle risque d&#39;être biaisé.&quot;</span><span class="p">)</span>

    <span class="c1"># Pondération des classes pour le ML (inverse de la fréquence)</span>
    <span class="n">class_counts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">total</span><span class="o">/</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">class_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal_binary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Normalisation des features numériques (hors cible, hors timestamp)</span>
    <span class="n">features_to_normalize</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span>
        <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span>
    <span class="p">]</span>
    <span class="n">features_to_normalize</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features_to_normalize</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
    <span class="n">df_norm</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_norm</span><span class="p">[</span><span class="n">features_to_normalize</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features_to_normalize</span><span class="p">])</span>
    <span class="c1"># Export version normalisée et brute</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">df_norm</span><span class="p">[</span><span class="s1">&#39;timestamp_str&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">cols_utiles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span>
        <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;signal_binary&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_str&#39;</span>
    <span class="p">]</span>
    <span class="n">cols_utiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_utiles</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">df_to_export</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols_utiles</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_norm_to_export</span> <span class="o">=</span> <span class="n">df_norm</span><span class="p">[</span><span class="n">cols_utiles</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_to_export</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">df_norm_to_export</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;_norm.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Préparation terminée.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset filtré enregistré sous </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2"> (brut) et </span><span class="si">{</span><span class="n">output_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_norm.csv&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> (normalisé).&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape du dataset final : </span><span class="si">{</span><span class="n">df_to_export</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aperçu des premières lignes :&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df_to_export</span><span class="o">.</span><span class="n">head</span><span class="p">())</span></div>


<div class="viewcode-block" id="prepare_ml_csv">
<a class="viewcode-back" href="../../core/preprocessing.html#scripts.prepare_features.prepare_ml_csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">prepare_ml_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prépare un CSV compatible ML à partir d&#39;un CSV brut issu de MetaTrader ou autre.</span>
<span class="sd">    - Renomme les colonnes pour qu&#39;elles soient compatibles avec XGBoost/sklearn</span>
<span class="sd">    - Ajoute les colonnes de features techniques manquantes (valeurs NaN ou calculées)</span>
<span class="sd">    - Sauvegarde le CSV prêt pour l&#39;entraînement ML</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Mapping des noms bruts vers noms ML</span>
    <span class="n">col_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&lt;DATE&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;TIME&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;OPEN&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;TICKVOL&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;VOL&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;vol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;SPREAD&gt;&#39;</span><span class="p">:</span> <span class="s1">&#39;spread&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_map</span><span class="p">)</span>

    <span class="c1"># Colonnes attendues pour le ML (voir scripts/prepare_features.py et core/ml_train.py)</span>
    <span class="n">cols_utiles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span>
        <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span>
    <span class="p">]</span>
    <span class="c1"># Ajoute les colonnes manquantes avec NaN</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_utiles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># Optionnel : générer les features techniques ici si besoin</span>
    <span class="c1"># fe = FeatureEngineering()</span>
    <span class="c1"># df = fe.transform(df)</span>
    <span class="c1"># Ajoute une colonne timestamp si absente</span>
    <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="c1"># Ajoute une colonne signal par défaut (0)</span>
    <span class="k">if</span> <span class="s1">&#39;signal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Réordonne les colonnes</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols_utiles</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nouveau CSV ML prêt : </span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Ensure the input file exists or adjust path.</span>
    <span class="c1"># The user provided &quot;data/features/BTCUSD_M1_201812120809_202505271849.csv&quot;</span>
    <span class="c1"># This path implies the script is run from the project root.</span>
    <span class="c1"># If INPUT_CSV_PATH is not found, the script will print an error and exit.</span>
    <span class="n">prepare_dataset</span><span class="p">(</span><span class="n">INPUT_CSV_PATH</span><span class="p">,</span> <span class="n">OUTPUT_CSV_PATH</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">bitcoin_scalper</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../web_api.html">Web API (FastAPI)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../config.html">config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../config.html#gestion-securisee-de-la-configuration">Gestion sécurisée de la configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_cleaner.html">data_cleaner module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_ingestor.html">data_ingestor module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dvc_manager.html">dvc_manager module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../feature_engineering.html">feature_engineering module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ml_pipeline.html">ml_pipeline module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../order_algos.html">order_algos module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../risk_management.html">risk_management module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timescaledb_client.html">timescaledb_client module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backtesting.html">backtesting module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../backtesting.html#module-bitcoin_scalper.core.backtesting">Backtesting avancé</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Code du module</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Thibault Leray.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>