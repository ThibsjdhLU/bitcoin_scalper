<!DOCTYPE html>

<html lang="fr" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bitcoin_scalper.core.feature_engineering &#8212; Documentation bitcoin_scalper 1.0</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=7a28dfa3"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/translations.js?v=e6b791cb"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Code source de bitcoin_scalper.core.feature_engineering</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_ta</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ta</span>  <span class="c1"># Réactivation : nécessaire pour SuperTrend</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ta.momentum</span><span class="w"> </span><span class="kn">import</span> <span class="n">RSIIndicator</span><span class="p">,</span> <span class="n">TSIIndicator</span><span class="p">,</span> <span class="n">StochRSIIndicator</span><span class="p">,</span> <span class="n">WilliamsRIndicator</span><span class="p">,</span> <span class="n">UltimateOscillator</span><span class="p">,</span> <span class="n">ROCIndicator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ta.trend</span><span class="w"> </span><span class="kn">import</span> <span class="n">MACD</span><span class="p">,</span> <span class="n">EMAIndicator</span><span class="p">,</span> <span class="n">SMAIndicator</span><span class="p">,</span> <span class="n">ADXIndicator</span><span class="p">,</span> <span class="n">PSARIndicator</span><span class="p">,</span> <span class="n">IchimokuIndicator</span><span class="p">,</span> <span class="n">CCIIndicator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ta.volatility</span><span class="w"> </span><span class="kn">import</span> <span class="n">BollingerBands</span><span class="p">,</span> <span class="n">AverageTrueRange</span><span class="p">,</span> <span class="n">KeltnerChannel</span><span class="p">,</span> <span class="n">DonchianChannel</span><span class="p">,</span> <span class="n">UlcerIndex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ta.volume</span><span class="w"> </span><span class="kn">import</span> <span class="n">MFIIndicator</span><span class="p">,</span> <span class="n">OnBalanceVolumeIndicator</span><span class="p">,</span> <span class="n">AccDistIndexIndicator</span><span class="p">,</span> <span class="n">ChaikinMoneyFlowIndicator</span>
<span class="c1"># from ta.trend import SuperTrendIndicator # Suppression : SuperTrendIndicator n&#39;existe pas dans ta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">zscore</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;bitcoin_scalper.feature_engineering&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%(asctime)s</span><span class="s1">][</span><span class="si">%(levelname)s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">hasHandlers</span><span class="p">():</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module de feature engineering pour le bot Bitcoin Scalper.</span>
<span class="sd">Génère tous les indicateurs techniques et features nécessaires au pipeline ML :</span>
<span class="sd">- rsi, macd, macd_signal, macd_diff</span>
<span class="sd">- ema_21, ema_50, sma_20</span>
<span class="sd">- bb_high, bb_low, bb_width</span>
<span class="sd">- atr, supertrend, vwap</span>
<span class="sd">- tickvol (copie de volume si absent)</span>
<span class="sd">- close_sma_3 (SMA 3 sur close)</span>
<span class="sd">- atr_sma_20 (SMA 20 sur ATR)</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="FeatureEngineering">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.FeatureEngineering">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FeatureEngineering</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calcul vectorisé d&#39;indicateurs techniques et extraction de features dérivées pour pipeline ML.</span>
<span class="sd">    Génère systématiquement :</span>
<span class="sd">      - rsi, macd, macd_signal, macd_diff</span>
<span class="sd">      - ema_21, ema_50, sma_20</span>
<span class="sd">      - bb_high, bb_low, bb_width</span>
<span class="sd">      - atr, supertrend, vwap</span>
<span class="sd">      - tickvol (copie de volume si absent)</span>
<span class="sd">      - close_sma_3 (SMA 3 sur close)</span>
<span class="sd">      - atr_sma_20 (SMA 20 sur ATR)</span>
<span class="sd">    Support multi-timeframe, API flexible, pas d&#39;IO (purement transformation DataFrame).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeframes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeframes</span> <span class="o">=</span> <span class="n">timeframes</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;1min&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="FeatureEngineering.add_indicators">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.FeatureEngineering.add_indicators">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_indicators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">price_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="n">high_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="n">low_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ajoute les indicateurs techniques principaux et avancés au DataFrame OHLCV.</span>
<span class="sd">        Sécurité :</span>
<span class="sd">            - Tous les indicateurs sont décalés d&#39;une bougie (shift(1)) pour éviter tout look-ahead bias.</span>
<span class="sd">            - VWAP est calculé de façon cumulative et décalée.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="n">high_col</span><span class="p">,</span> <span class="n">low_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="c1"># --- Ajout : dupliquer les colonnes OHLCV d&#39;origine en version préfixée si un préfixe est fourni ---</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">price_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">high_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">low_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">volume_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;tickvol&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">tickvol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tickvol&#39;</span><span class="p">]</span>
        <span class="c1"># 1. Calcul des indicateurs de base (sans shift)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rsi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rsi</span><span class="p">()</span>
        <span class="n">macd</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd_signal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd_signal</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd_diff</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ema_21&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ema_50&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">sma_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMAIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sma_indicator</span><span class="p">()</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">BollingerBands</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">window_dev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bollinger_hband</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bollinger_lband</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bb</span><span class="o">.</span><span class="n">bollinger_wband</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">:</span>
            <span class="n">atr</span> <span class="o">=</span> <span class="n">AverageTrueRange</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">average_true_range</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Utilisation de pandas_ta.supertrend</span>
        <span class="c1"># La fonction retourne un DataFrame avec plusieurs colonnes (SUPERT_l_m, SUPERTd_l_m, SUPERTl_l_m, SUPERTs_l_m)</span>
        <span class="c1"># où l est length et m est multiplier</span>
        <span class="n">supertrend_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">ta</span><span class="o">.</span><span class="n">supertrend</span><span class="p">(</span>
            <span class="n">length</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>           <span class="c1"># Fenêtre pour ATR</span>
            <span class="n">multiplier</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>     <span class="c1"># Multiplicateur pour ATR</span>
            <span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span>    <span class="c1"># Colonne close</span>
            <span class="n">high</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span>      <span class="c1"># Colonne high</span>
            <span class="n">low</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span>        <span class="c1"># Colonne low</span>
            <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">supertrend_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">supertrend_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># Ajouter cette ligne pour inférer les types et faire une copie explicite</span>
            <span class="n">supertrend_data</span> <span class="o">=</span> <span class="n">supertrend_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Noms des colonnes générées par pandas_ta</span>
            <span class="n">supertrend_line_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SUPERT_</span><span class="si">{</span><span class="mi">7</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="mf">3.0</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">supertrend_direction_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SUPERTd_</span><span class="si">{</span><span class="mi">7</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="mf">3.0</span><span class="si">}</span><span class="s1">&#39;</span> <span class="c1"># Nom correct pour la direction</span>

            <span class="k">if</span> <span class="n">supertrend_line_col</span> <span class="ow">in</span> <span class="n">supertrend_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supertrend_data</span><span class="p">[</span><span class="n">supertrend_line_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colonne SuperTrend &#39;</span><span class="si">{</span><span class="n">supertrend_line_col</span><span class="si">}</span><span class="s2">&#39; non trouvée. Colonnes disponibles : </span><span class="si">{</span><span class="n">supertrend_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">if</span> <span class="n">supertrend_direction_col</span> <span class="ow">in</span> <span class="n">supertrend_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># Correction : cast explicite en float pour éviter le warning</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend_direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">supertrend_data</span><span class="p">[</span><span class="n">supertrend_direction_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colonne SuperTrend Direction &#39;</span><span class="si">{</span><span class="n">supertrend_direction_col</span><span class="si">}</span><span class="s2">&#39; non trouvée.&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend_direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend_direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">vwap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">])</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">())</span>
        <span class="k">if</span> <span class="s1">&#39;tickvol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">volume_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tickvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tickvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># Correction : appliquer infer_objects après fillna/ffill/bfill si besoin</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># 2. Décalage immédiat de tous les indicateurs de base (sécurité temporelle)</span>
        <span class="n">base_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">rsi&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd_signal&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">macd_diff&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ema_21&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ema_50&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">sma_20&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_high&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_low&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_width&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">supertrend&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">vwap&quot;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">base_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 3. Calcul des features dérivées UNIQUEMENT à partir des colonnes déjà décalées</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">close&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">close_sma_3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">close_sma_3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr_sma_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">atr_sma_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># 4. Ne jamais re-shifter les features dérivées !</span>
        <span class="c1"># Toutes les features sont désormais temporellement sûres.</span>
        <span class="c1"># --- Indicateurs avancés (volatilité, volume, momentum, trend) ---</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Volatilité</span>
            <span class="n">kc</span> <span class="o">=</span> <span class="n">KeltnerChannel</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">window_atr</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_hband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">keltner_channel_hband</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_lband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">keltner_channel_lband</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kc</span><span class="o">.</span><span class="n">keltner_channel_wband</span><span class="p">()</span>
            <span class="n">dc</span> <span class="o">=</span> <span class="n">DonchianChannel</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_hband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">donchian_channel_hband</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_lband&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">donchian_channel_lband</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="o">.</span><span class="n">donchian_channel_wband</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">ta.volatility</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChandelierExit</span>
                <span class="n">ce</span> <span class="o">=</span> <span class="n">ChandelierExit</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">window_atr</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">chandelier_exit_long</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_short&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">chandelier_exit_short</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ChandelierExit non disponible dans ta.volatility pour cette version de ta.&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_short&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur lors du calcul de ChandelierExit : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_short&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">ui</span> <span class="o">=</span> <span class="n">UlcerIndex</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ulcer_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">ulcer_index</span><span class="p">()</span>
            <span class="c1"># Volume</span>
            <span class="n">mfi</span> <span class="o">=</span> <span class="n">MFIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">mfi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfi</span><span class="o">.</span><span class="n">money_flow_index</span><span class="p">()</span>
            <span class="n">obv</span> <span class="o">=</span> <span class="n">OnBalanceVolumeIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">],</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">obv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obv</span><span class="o">.</span><span class="n">on_balance_volume</span><span class="p">()</span>
            <span class="n">adi</span> <span class="o">=</span> <span class="n">AccDistIndexIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">],</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adi</span><span class="o">.</span><span class="n">acc_dist_index</span><span class="p">()</span>
            <span class="n">cmf</span> <span class="o">=</span> <span class="n">ChaikinMoneyFlowIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">cmf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmf</span><span class="o">.</span><span class="n">chaikin_money_flow</span><span class="p">()</span>
            <span class="c1"># Momentum</span>
            <span class="n">tsi</span> <span class="o">=</span> <span class="n">TSIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window_slow</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">window_fast</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">tsi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsi</span><span class="o">.</span><span class="n">tsi</span><span class="p">()</span>
            <span class="n">cci</span> <span class="o">=</span> <span class="n">CCIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">cci&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cci</span><span class="o">.</span><span class="n">cci</span><span class="p">()</span>
            <span class="n">willr</span> <span class="o">=</span> <span class="n">WilliamsRIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">lbp</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">willr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">willr</span><span class="o">.</span><span class="n">williams_r</span><span class="p">()</span>
            <span class="n">stochrsi</span> <span class="o">=</span> <span class="n">StochRSIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">smooth1</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">smooth2</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">stochrsi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stochrsi</span><span class="o">.</span><span class="n">stochrsi</span><span class="p">()</span>
            <span class="n">uo</span> <span class="o">=</span> <span class="n">UltimateOscillator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window1</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">window2</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">window3</span><span class="o">=</span><span class="mi">28</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ultimate_osc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uo</span><span class="o">.</span><span class="n">ultimate_oscillator</span><span class="p">()</span>
            <span class="n">roc</span> <span class="o">=</span> <span class="n">ROCIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">roc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc</span><span class="o">.</span><span class="n">roc</span><span class="p">()</span>
            <span class="c1"># Trend</span>
            <span class="n">adx</span> <span class="o">=</span> <span class="n">ADXIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx_pos</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx_neg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx_neg</span><span class="p">()</span>
            <span class="n">psar</span> <span class="o">=</span> <span class="n">PSARIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">psar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psar</span><span class="o">.</span><span class="n">psar</span><span class="p">()</span>
            <span class="n">ichimoku</span> <span class="o">=</span> <span class="n">IchimokuIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">high_col</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">low_col</span><span class="p">],</span> <span class="n">window1</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">window2</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">window3</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ichimoku</span><span class="o">.</span><span class="n">ichimoku_a</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ichimoku</span><span class="o">.</span><span class="n">ichimoku_b</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_base_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ichimoku</span><span class="o">.</span><span class="n">ichimoku_base_line</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_conversion_line&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ichimoku</span><span class="o">.</span><span class="n">ichimoku_conversion_line</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">ta.trend</span><span class="w"> </span><span class="kn">import</span> <span class="n">PPOIndicator</span>
                <span class="n">ppo</span> <span class="o">=</span> <span class="n">PPOIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">],</span> <span class="n">window_slow</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">window_fast</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">window_sign</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppo</span><span class="o">.</span><span class="n">ppo</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_signal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppo</span><span class="o">.</span><span class="n">ppo_signal</span><span class="p">()</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_hist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppo</span><span class="o">.</span><span class="n">ppo_hist</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;PPOIndicator non disponible dans ta.trend pour cette version de ta.&quot;</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_signal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_hist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erreur lors du calcul des indicateurs avancés : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Décalage immédiat de tous les indicateurs avancés (sécurité temporelle)</span>
        <span class="n">advanced_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_hband&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_lband&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">kc_width&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_hband&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_lband&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">donchian_width&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_long&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">chandelier_exit_short&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ulcer_index&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">mfi&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">obv&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adi&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">cmf&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">tsi&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">cci&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">willr&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">stochrsi&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ultimate_osc&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">roc&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx_pos&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">adx_neg&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">psar&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_a&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_b&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_base_line&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ichimoku_conversion_line&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_signal&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">ppo_hist&quot;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">advanced_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FeatureEngineering.add_features">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.FeatureEngineering.add_features">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">price_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ajoute des features dérivées (retours, volatilité, ratios, z-score, distances, encodages temporels, etc).</span>
<span class="sd">        Sécurité :</span>
<span class="sd">            - Toutes les features sont décalées d&#39;une bougie (shift(1)) pour éviter tout look-ahead bias.</span>
<span class="sd">        :param df: DataFrame d&#39;entrée</span>
<span class="sd">        :param price_col: Colonne de prix (par défaut &#39;close&#39;)</span>
<span class="sd">        :param volume_col: Colonne de volume (par défaut &#39;volume&#39;)</span>
<span class="sd">        :param prefix: Préfixe optionnel pour les colonnes</span>
<span class="sd">        :return: DataFrame enrichi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">required_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">required_cols</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="c1"># Retours log et simples</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">log_return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Ajout harmonisé de log_return_1m (pour compatibilité labeling et backtest)</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;1min_&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">price_col</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;CLOSE&gt;&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="s1">&#39;log_return_1m&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">price_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_return_1m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Volatilité rolling</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">volatility_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">return&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Ratio volume/prix (pas besoin de shift)</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">vol_price_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">volume_col</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="c1"># --- Z-score généralisé ---</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">win</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
                    <span class="n">mean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-9</span>
                    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">col</span><span class="si">}</span><span class="s2">_zscore_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># --- Distance à la bande de Bollinger ---</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_high&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_low&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dist_bb_high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_high&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dist_bb_low&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_low&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dist_bb_width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_high&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">bb_low&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># --- Distance au plus haut/bas N périodes ---</span>
        <span class="k">for</span> <span class="n">win</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">price_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dist_high_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">dist_low_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">price_col</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># --- Encodage temporel enrichi ---</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;hour&#39;</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">minute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">day&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">week&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;isocalendar&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">week</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">quarter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">quarter</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;quarter&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
            <span class="c1"># Encodage cyclique</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">minute_sin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">minute_cos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">hour_sin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">hour_cos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">weekday_sin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">weekday_cos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">month_sin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">month_cos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">12</span><span class="p">)</span>
            <span class="c1"># Position relative dans la journée/semaine/mois</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">hour_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span> <span class="o">/</span> <span class="mi">23</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">weekday_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">weekday</span> <span class="o">/</span> <span class="mi">6</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">month_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="FeatureEngineering.multi_timeframe">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.FeatureEngineering.multi_timeframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">multi_timeframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">price_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;CLOSE&gt;&quot;</span><span class="p">,</span> <span class="n">high_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;HIGH&gt;&quot;</span><span class="p">,</span> <span class="n">low_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;LOW&gt;&quot;</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;TICKVOL&gt;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fusionne et concatène les features multi-timeframe (clé = timeframe, valeur = DataFrame OHLCV).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dfs</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Retourne un DataFrame vide indexé sur rien</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># S&#39;assurer que le timeframe de base (1min) est traité en premier si possible</span>
        <span class="n">timeframes_ordered</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="s2">&quot;1min&quot;</span> <span class="ow">in</span> <span class="n">timeframes_ordered</span><span class="p">:</span>
            <span class="n">timeframes_ordered</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeframes_ordered</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">timeframes_ordered</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;1min&quot;</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">timeframes_ordered</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span>
            <span class="c1"># Auto-mapping des colonnes si elles sont en minuscules (cas test)</span>
            <span class="n">col_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;open&quot;</span><span class="p">:</span> <span class="n">price_col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;CLOSE&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;OPEN&gt;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;open&quot;</span><span class="p">),</span>
                <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">high_col</span><span class="p">,</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">low_col</span><span class="p">,</span>
                <span class="s2">&quot;close&quot;</span><span class="p">:</span> <span class="n">price_col</span><span class="p">,</span>
                <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="n">volume_col</span><span class="p">,</span>
                <span class="s2">&quot;tickvol&quot;</span><span class="p">:</span> <span class="n">volume_col</span> <span class="k">if</span> <span class="n">volume_col</span> <span class="o">==</span> <span class="s2">&quot;tickvol&quot;</span> <span class="k">else</span> <span class="s2">&quot;tickvol&quot;</span>
            <span class="p">}</span>
            <span class="c1"># Si les colonnes sont en minuscules, on les renomme pour matcher l&#39;API</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_map</span><span class="p">)</span>
            <span class="c1"># Appliquer add_indicators puis add_features pour chaque timeframe</span>
            <span class="n">df_tf_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">price_col</span><span class="p">,</span> <span class="n">high_col</span><span class="p">,</span> <span class="n">low_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="n">df_tf_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_features</span><span class="p">(</span><span class="n">df_tf_features</span><span class="p">,</span> <span class="n">price_col</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_close&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_close&quot;</span> <span class="ow">in</span> <span class="n">df_tf_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">price_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_volume&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_volume&quot;</span> <span class="ow">in</span> <span class="n">df_tf_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">volume_col</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">df_tf_features</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols_to_join</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_tf_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tf</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">df_tf_features</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">original_ohlcv_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="n">high_col</span><span class="p">,</span> <span class="n">low_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">,</span> <span class="s2">&quot;tickvol&quot;</span><span class="p">]</span>
                <span class="n">cols_to_join</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_join</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_ohlcv_cols</span><span class="p">]</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_tf_features</span><span class="p">[</span><span class="n">cols_to_join</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1"># Suppression des colonnes OHLCV originales si leur version 1min_ préfixée existe</span>
        <span class="n">cols_to_drop_original</span> <span class="o">=</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="n">high_col</span><span class="p">,</span> <span class="n">low_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;tickvol&#39;</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;tickvol&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_to_drop_original</span><span class="p">:</span>
            <span class="n">cols_to_drop_original</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;tickvol&#39;</span><span class="p">)</span>
        <span class="n">cols_to_drop_if_1min_prefixed_exists</span> <span class="o">=</span> <span class="p">[</span><span class="n">price_col</span><span class="p">,</span> <span class="n">high_col</span><span class="p">,</span> <span class="n">low_col</span><span class="p">,</span> <span class="n">volume_col</span><span class="p">,</span> <span class="s2">&quot;tickvol&quot;</span><span class="p">]</span>
        <span class="n">final_cols_to_drop</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols_to_drop_if_1min_prefixed_exists</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;1min_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">final_cols_to_drop</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base</span></div>
</div>


<div class="viewcode-block" id="test_add_indicators_all_features">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_add_indicators_all_features">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_add_indicators_all_features</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="c1"># Génère un DataFrame OHLCV minimal mais suffisant</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">expected_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_diff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;sma_20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bb_high&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_low&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_width&#39;</span><span class="p">,</span>
        <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span> <span class="s1">&#39;vwap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span> <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">expected_cols</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Feature manquante : </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="c1"># Vérifie que close_sma_3 et atr_sma_20 sont bien calculés</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;close_sma_3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

    <span class="c1"># assert not out[&#39;atr_sma_20&#39;].isnull().all() # Peut être NaN si pas assez de données</span>
    <span class="c1"># Vérifie que tickvol est cohérent avec volume</span>
    <span class="c1"># assert np.allclose(out[&#39;tickvol&#39;], out[&#39;volume&#39;]) # Volume et tickvol peuvent être différents dans la vraie donnée.</span>

<div class="viewcode-block" id="test_features_compatibility_with_reference">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_features_compatibility_with_reference">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_features_compatibility_with_reference</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vérifie que toutes les features attendues (ex: features_list.pkl) sont bien générées par add_indicators.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># Simule une liste de features de référence (ex: features_list.pkl)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_diff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;sma_20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bb_high&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_low&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_width&#39;</span><span class="p">,</span>
        <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span> <span class="s1">&#39;vwap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span> <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span>
    <span class="p">]</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">reference</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">missing</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Features manquantes vs référence : </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="test_add_indicators_incomplete_df">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_add_indicators_incomplete_df">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_add_indicators_incomplete_df</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vérifie que add_indicators ne plante pas et retourne un DataFrame même si des colonnes sont manquantes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="c1"># Cas 1 : DataFrame vide</span>
    <span class="n">df_empty</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">out_empty</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df_empty</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_empty</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="c1"># Cas 2 : DataFrame sans &#39;high&#39; ou &#39;low&#39;</span>
    <span class="n">df_partial</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>
    <span class="n">out_partial</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df_partial</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_partial</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="c1"># Cas 3 : DataFrame sans &#39;volume&#39;</span>
    <span class="n">df_novol</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]})</span>
    <span class="n">out_novol</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df_novol</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_novol</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span></div>


<div class="viewcode-block" id="test_add_indicators_with_tickvol">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_add_indicators_with_tickvol">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_add_indicators_with_tickvol</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vérifie que add_indicators fonctionne si le DataFrame utilise &#39;tickvol&#39; comme colonne de volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;tickvol&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">volume_col</span><span class="o">=</span><span class="s1">&#39;tickvol&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s1">&#39;tickvol&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s1">&#39;close_sma_3&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">assert</span> <span class="s1">&#39;atr_sma_20&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span></div>


<div class="viewcode-block" id="test_feature_order_matches_reference">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_feature_order_matches_reference">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_feature_order_matches_reference</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vérifie que l&#39;ordre des features générées correspond à la liste de référence (features_list.pkl).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;macd&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;macd_diff&#39;</span><span class="p">,</span>
        <span class="s1">&#39;ema_21&#39;</span><span class="p">,</span> <span class="s1">&#39;ema_50&#39;</span><span class="p">,</span> <span class="s1">&#39;sma_20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bb_high&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_low&#39;</span><span class="p">,</span> <span class="s1">&#39;bb_width&#39;</span><span class="p">,</span>
        <span class="s1">&#39;atr&#39;</span><span class="p">,</span> <span class="s1">&#39;supertrend&#39;</span><span class="p">,</span> <span class="s1">&#39;vwap&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tickvol&#39;</span><span class="p">,</span> <span class="s1">&#39;close_sma_3&#39;</span><span class="p">,</span> <span class="s1">&#39;atr_sma_20&#39;</span>
    <span class="p">]</span>
    <span class="c1"># On ne vérifie que l&#39;ordre des colonnes présentes dans la référence</span>
    <span class="n">generated</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">reference</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">generated</span> <span class="o">==</span> <span class="n">reference</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Ordre des features incorrect : </span><span class="si">{</span><span class="n">generated</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="test_supertrend_typing">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.test_supertrend_typing">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_supertrend_typing</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">FeatureEngineering</span><span class="p">()</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">99</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">fe</span><span class="o">.</span><span class="n">add_indicators</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;supertrend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span>
        <span class="k">assert</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;supertrend_direction&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;FutureWarning&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">message</span><span class="p">)</span> <span class="k">for</span> <span class="n">warn</span> <span class="ow">in</span> <span class="n">w</span><span class="p">)</span></div>


<div class="viewcode-block" id="add_features">
<a class="viewcode-back" href="../../../core/feature_engineering.html#bitcoin_scalper.core.feature_engineering.add_features">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_features</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enrichit un DataFrame minute BTC avec toutes les features financières et temporelles requises pour le ML, dont log_return_1m systématique.</span>
<span class="sd">    Toutes les features sont calculées de façon causale (aucune fuite d&#39;information vers le futur).</span>
<span class="sd">    Les NaN générés par les rollings sont explicitement traqués et loggés.</span>
<span class="sd">    :param df: DataFrame prétraité, indexé par datetime UTC, colonnes : OPEN, HIGH, LOW, CLOSE, TICKVOL</span>
<span class="sd">    :return: DataFrame enrichi avec les features demandées</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Début de l&#39;enrichissement des features financières et temporelles.&quot;</span><span class="p">)</span>
    <span class="c1"># 1. Prix moyens</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;HLC3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;OC2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;OPEN&gt;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Prix moyens calculés : HL2, HLC3, OC2.&quot;</span><span class="p">)</span>
    <span class="c1"># 2. Retours log</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_return_1m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="c1"># Alias pour compatibilité orchestrator/backtest</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;1min_log_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_return_1m&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;log_return_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Retours log calculés sur 1, 3, 5, 15 minutes.&quot;</span><span class="p">)</span>
    <span class="c1"># 3. Volatilité locale (rolling std des log_return_*)</span>
    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log_return_1m&#39;</span><span class="p">,</span> <span class="s1">&#39;log_return_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;log_return_5m&#39;</span><span class="p">,</span> <span class="s1">&#39;log_return_15m&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">win</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">]:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">_std_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s1">m&#39;</span>
            <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">base</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Volatilité locale (rolling std) calculée.&quot;</span><span class="p">)</span>
    <span class="c1"># 4. Moyennes mobiles</span>
    <span class="k">for</span> <span class="n">win</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;SMA_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;EMA_</span><span class="si">{</span><span class="n">win</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">win</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Moyennes mobiles SMA/EMA calculées.&quot;</span><span class="p">)</span>
    <span class="c1"># 5. Indicateurs techniques</span>
    <span class="c1"># RSI(14)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">down</span> <span class="o">=</span> <span class="o">-</span><span class="n">delta</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">upper</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">roll_up</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">roll_down</span> <span class="o">=</span> <span class="n">down</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="n">roll_up</span> <span class="o">/</span> <span class="p">(</span><span class="n">roll_down</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rs</span><span class="p">))</span>
    <span class="c1"># MACD(12,26,9)</span>
    <span class="n">ema12</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">ema26</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ema12</span> <span class="o">-</span> <span class="n">ema26</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="c1"># ATR(14)</span>
    <span class="n">high_low</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">]</span>
    <span class="n">high_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;HIGH&gt;&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">low_close</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;LOW&gt;&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">high_low</span><span class="p">,</span> <span class="n">high_close</span><span class="p">,</span> <span class="n">low_close</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="c1"># Bollinger Bands(20)</span>
    <span class="n">ma20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_MA_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma20</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_UPPER_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma20</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std20</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_LOWER_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma20</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std20</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_WIDTH_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_UPPER_20&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;BB_LOWER_20&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Indicateurs techniques calculés : RSI, MACD, ATR, Bollinger Bands.&quot;</span><span class="p">)</span>
    <span class="c1"># 6. Statistiques dérivées</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Z_SCORE_30&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">)</span>
    <span class="c1"># Slope locale (pente linéaire) sur fenêtre 15</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rolling_slope</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">slopes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">slopes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">return</span> <span class="n">slopes</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;SLOPE_15&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;&lt;CLOSE&gt;&#39;</span><span class="p">],</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Statistiques dérivées calculées : Z-score, slope locale.&quot;</span><span class="p">)</span>
    <span class="c1"># 7. Encodage temporel</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">hour</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hours</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hours</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">dows</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dow_sin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dows</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dow_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">dows</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Encodage temporel effectué (heures, jours de semaine).&quot;</span><span class="p">)</span>
    <span class="c1"># Traque des NaN</span>
    <span class="n">nan_report</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">nan_cols</span> <span class="o">=</span> <span class="n">nan_report</span><span class="p">[</span><span class="n">nan_report</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nan_cols</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Colonnes avec NaN générés par les rollings : </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="n">nan_cols</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aucun NaN généré par les rollings.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features enrichies : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> colonnes.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Exemple d&#39;utilisation :</span>
<span class="sd">fe = FeatureEngineering([&quot;1min&quot;, &quot;5min&quot;])</span>
<span class="sd">df_1m = fe.add_indicators(df_1m)</span>
<span class="sd">df_1m = fe.add_features(df_1m)</span>
<span class="sd">features = fe.multi_timeframe({&quot;1min&quot;: df_1m, &quot;5min&quot;: df_5m})</span>
<span class="sd">&quot;&quot;&quot;</span> 
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">bitcoin_scalper</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../web_api.html">Web API (FastAPI)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html">config module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config.html#gestion-securisee-de-la-configuration">Gestion sécurisée de la configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_cleaner.html">data_cleaner module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_ingestor.html">data_ingestor module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dvc_manager.html">dvc_manager module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../feature_engineering.html">feature_engineering module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ml_pipeline.html">ml_pipeline module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../order_algos.html">order_algos module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../risk_management.html">risk_management module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timescaledb_client.html">timescaledb_client module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backtesting.html">backtesting module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../backtesting.html#module-bitcoin_scalper.core.backtesting">Backtesting avancé</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Code du module</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Thibault Leray.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>